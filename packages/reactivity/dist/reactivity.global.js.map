{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["\nexport const isObject = (value) => typeof value == 'object' && value !== null;\nexport const extend = Object.assign","\nexport function effect(fn,options:any = {}) {\n\tconst effect = createReactiveEffect(fn,options)\n\n\tif(!options.lazy){\n\t\teffect()// effect默认会先执行一次\n\t}\n\n\treturn effect\n}\nlet uid = 0\nlet activeEffect //用于存储当前effect\nconst effectStack = []\nfunction createReactiveEffect(fn,options){\n\tconst effect = function reactiveEffect() {\n\t\tconsole.log('todo...')\n\t\tif(!effectStack.includes(effect)){\n\t\t\ttry {\n\t\t\t\teffectStack.push(effect)\n\t\t\t\tactiveEffect = effect\n\t\t\t\treturn fn()// 函数执行 会执行get方法\n\t\t\t} finally {\n\t\t\t\teffectStack.pop()\n\t\t\t\tactiveEffect = effectStack[effectStack.length - 1]\n\t\t\t}\n\t\t}\n\t\t\n\t}\n\teffect.id = uid++ //加id用于区分effect\n\teffect._isEffect = true // 标识这是一个响应式的effect\n\teffect.raw = fn // 保存effect对应的原函数\n\teffect.options = options // 在effect上保存用户的属性\n\treturn effect\n}\n// 对象属性收集他对应的effect函数 相当于2中的watcher\nconst targetMap = new WeakMap();\nexport function track(target, type, key){\n\t// activeEffect\n\tif(activeEffect === undefined) {\n\t\treturn;\n\t}\n\tlet depsMap = targetMap.get(target)\n\tif(!depsMap){\n\t\ttargetMap.set(target,(depsMap = new Map))\n\t}\n\tlet dep = depsMap.get(key)\n\tif(!dep){\n\t\tdepsMap.set(key,(dep = new Set))\n\t}\n\tif(!dep.has(activeEffect)){\n\t\tdep.add(activeEffect)\n\t}\n\t// 这个dep的key就是object的属性如state.name中的name，value就是effect(fn) 中的fn，即是副作用activeEffect\n\tconsole.log(targetMap, key, target)\n\t// console.log(target,key,activeEffect)\n}","import { extend, isObject } from '@vue/shared/src'\nimport { readonly, reactive } from './reactive'\nimport { track } from './effect'\nimport { TrackOpTyps } from './operators'\n\nfunction createGetter(isReadonly = false, shallow = false) {// 拦截获取功能\n\treturn function get(target, key, receiver){\n\t\t// proxy + reflect\n\t\t// 后续Object上的方法 会迁移到Reflect ,之前的target[key] = value 方式设置值可能会失败，并不会报异常，也没有返回值标识\n\t\tconst res = Reflect.get(target, key, receiver)\n\n\t\tif(!isReadonly){\n\t\t\t// 依赖收集，数据变化时更新视图\n\t\t\tconsole.log('执行effect时会取值','收集effect')\n\t\t\ttrack(target, TrackOpTyps.GET, key)\n\t\t}\n\n\t\tif(shallow){\n\t\t\treturn res\n\t\t}\n\n\t\tif(isObject(res)){ //vue2 是一上来就递归，vue3是取值时才进行\n\t\t\treturn isReadonly ? readonly(res) : reactive(res)\n\t\t}\n\t}\n}\n\nfunction createSetter(shallow = false) { // 拦截设置功能\n\treturn function get(target, key, value, receiver){\n\t\tconst res = Reflect.set(target, key, value, receiver)\n\t\t// 数据更新时 通知对应属性的effect执行\n\n\t\treturn res\n\t}\n}\n\nconst get = createGetter()\nconst shallowGet = createGetter(false, true)\nconst readonlyGet = createGetter(true)\nconst shallowReadonlyGet = createGetter(true, true)\n\nconst set = createSetter()\nconst shallowSet = createSetter(true)\n\nexport const mutableHandlers = {\n\tget,\n\tset\n}\n\nexport const shallowReactiveHandlers = {\n\tget:shallowGet,\n\tset:shallowSet\n}\n\nlet readonlyObj = {\n\tset:(target,key)=>{\n\t\tconsole.warn(`set on '${target}' key '${key}' falied`)\n\t}\n}\n\nexport const shallowReadonlyHandlers = extend({\n\tget:shallowReadonlyGet,\n},readonlyObj)\n\nexport const readonlyHandlers = extend({\n\tget:readonlyGet\n},readonlyObj)\n\n","import { isObject } from '@vue/shared/src'\n\nimport {\n\tmutableHandlers,\n\tshallowReactiveHandlers,\n\tshallowReadonlyHandlers,\n\treadonlyHandlers,\n} from './baseHandlers'\nexport function reactive(target){\n\treturn createReactiveObject(target, false, mutableHandlers)\n\n} \n\nexport function shallowReactive(target){\n\treturn createReactiveObject(target, false, shallowReactiveHandlers)\n\n}\nexport function shallowReadonly(target){\n\treturn createReactiveObject(target, true, shallowReadonlyHandlers)\n\n}\nexport function readonly(target){\n\treturn createReactiveObject(target, true, readonlyHandlers)\n\n}\nconst reactiveMap = new WeakMap() //存储的key只能是对象，会自动垃圾回收，不会造成内存泄漏\nconst readonlyMap = new WeakMap()\nexport function createReactiveObject(target, isReadonly, baseHandlers){\n\t// 如果target不是对象，不拦截，reactive这个api只能拦截对象类型\n\tif(!isObject(target)){\n\t\treturn target\n\t}\n\tconst proxyMap = isReadonly ? readonlyMap : reactiveMap\n\tconst existProxy = proxyMap.get(target)\n\tif(existProxy){\n\t\treturn existProxy\n\t}\n\tconst proxy = new Proxy(target, baseHandlers)\n\tproxyMap.set(target,proxy)\n\treturn proxy;\n}"],"names":[],"mappings":"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"}